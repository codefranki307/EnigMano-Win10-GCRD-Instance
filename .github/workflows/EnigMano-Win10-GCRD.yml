name: "ü™Ñ Imad Khan ‚Äî Windows 10 Precision RDP"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Google Remote Desktop Code"
        required: true
      PIN:
        description: "CRD PIN (6+ digits)"
        required: false
        default: "123456"

jobs:
  crd-register:
    # This is the 'worker' used by EnigMano. 
    # Provides 4-vCPU & 16GB RAM on public repos.
    runs-on: windows-2022 
    timeout-minutes: 340 # Total Mission Time: 340 minutes
    name: "üöÄ Imad Khan 16GB Workstation"

    env:
      RAW_CODE: ${{ github.event.inputs.CODE }}
      PIN_INPUT: ${{ github.event.inputs.PIN }}
      # We use the official setup action for the most stable Python install
      PYTHON_VER: "3.14.2"

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üêç Step 1: Initialize Python ${{ env.PYTHON_VER }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VER }}

      - name: "üì¶ Step 2: Provision Environment"
        run: |
          python -m pip install --upgrade pip
          pip install requests playwright httpx[http2]
          playwright install chromium
          Write-Host "‚úÖ Python Suite & Playwright Ready."

      - name: "üõ°Ô∏è Step 3: Proton VPN Deployment"
        run: |
          $vpnUrl = "https://protonvpn.com/download/ProtonVPN_v4.3.11_x64.exe"
          $vpnPath = Join-Path $env:TEMP "ProtonVPN_Setup.exe"
          Invoke-WebRequest -Uri $vpnUrl -OutFile $vpnPath -UseBasicParsing
          Start-Process -FilePath $vpnPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          Write-Host "‚úÖ Proton VPN Installed."

      - name: "üåê Step 4: Google Remote Desktop Setup"
        run: |
          $crdMsi = Join-Path $env:TEMP "crdhost.msi"
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $crdMsi -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", $crdMsi, "/qn", "/norestart" -Wait
          
          # Extract only the code if the full command was pasted
          $authCode = if ($env:RAW_CODE -match '--code="([^"]+)"') { $matches[1] } else { $env:RAW_CODE }
          $hostStarter = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          
          Write-Host "üöÄ Launching GCRD..."
          & $hostStarter --code="$authCode" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$env:COMPUTERNAME --pin=$env:PIN_INPUT
          Write-Host "‚úÖ GCRD Connection established."

      - name: "‚è≥ Step 5: Mission Control Loop (340 Minutes)"
        run: |
          Write-Host "==============================================="
          Write-Host "üë§ OWNER       : Imad Khan"
          Write-Host "üïí MISSION START: $(Get-Date)"
          Write-Host "==============================================="
          
          for ($i=1; $i -le 340; $i++) {
              # RELAY TRIGGER @ 330 MINUTES
              if ($i -eq 330) {
                  Write-Host "‚úã RELAY TRIGGER: 330 minutes reached. Final 10-minute warning."
              }

              # SHUTDOWN COMMAND @ 335 MINUTES
              if ($i -eq 335) {
                  Write-Host "‚èπÔ∏è SHUTDOWN COMMAND: 335 minutes reached. Forcing System Shutdown."
                  shutdown /s /f /t 0
              }

              $rem = 340 - $i
              Write-Host "Minute: $i/340 ($rem mins remaining)"
              Start-Sleep -Seconds 60
          }
